import napari
import numpy as np
from pathlib import Path

from matplotlib.colors import TABLEAU_COLORS
# Import the reader function from your provided code
from napari_medical_image_formats import napari_get_reader

colors = list(TABLEAU_COLORS.values())

# Create a viewer
viewer = napari.Viewer(ndisplay=3)  # Set ndisplay to 3 for 3D view

# Function to open TIFF file
def open_dicom_file(file_path):
    reader = napari_get_reader(file_path)
    if reader is not None:
        layer_data = reader(file_path)
        for data, kwargs, layer_type in layer_data:
            if layer_type == "image":
                viewer.add_image(data, **kwargs)
                # Set the viewer to 3D mode if the image is 3D
                if data.ndim >= 3:
                    viewer.dims.ndisplay = 3
            else:
                # Handle other layer types if necessary
                pass
    else:
        print(f"Unable to read file: {file_path}")


# Example usage:
file_path = 'E:\MA_Data\MeasuredData\Synbone04.dcm'
open_dicom_file(file_path)

# # Spine35
# heads_list = [[], [], [], [[31.841209305408203, -43.459515437260755, 11.651367132888414]], [], [], [], [], [[33.64918475768728, -8.31472877279992, -5.5762552207654], [-27.86544725194981, -46.948843738083895, -7.98210763709075]], [[-30.296940315660567, -97.51472578719711, 26.243070796933146]], [[-28.665603450182562, -49.69429902176617, -8.817109295841924]], [[24.951718877509336, -53.794576904435175, -2.385605209337424], [-22.90548575823992, -45.4059976072327, 21.413326434850376]], [[24.755306207860734, -52.421061208500504, -2.3215987755900245]], [[-14.450368840047481, -112.11070408365487, 26.75303428349869], [9.789681077696534, 13.25111269664362, -5.000582470418605]], [[20.021090765388465, -47.303732677039434, 27.031909097867683], [25.515000936870813, -51.50808315104976, -2.5652434222616067]], [[26.66793555088146, -50.504180328714575, -1.767102042045297]], [[7.2360016507283085, -125.51725902320209, 25.866475824596147]], [[-27.88366996709528, -47.01502659400945, -7.318101099067922], [28.27780123581576, -55.334118449857684, 24.08211351127827]], [[23.9374895560219, -46.140204500549004, -1.0210611320430751], [-27.932158527403974, -48.859722401559004, -7.414646767989039], [-21.682971358206032, -48.77994142827419, 21.84911150602698]], [[-17.969454129504953, 0.054185547437909376, 21.59537999395927], [-22.89132888716887, 12.680264252088136, 8.88144404823111]], [[-21.90878039641795, 0.45880526135722005, 21.614608239849257]], [[-25.448241732729855, -6.044637241325938, 21.76062588439796]], [[32.96068622021717, -100.03191780376261, -4.949436736296067], [-29.698923653202833, -3.1919051367526805, 9.950654962080124]], [[21.79602258432841, -53.536614950204125, 26.601401587748363], [38.10864259389178, -95.03973678754772, -5.115302653929601]], [[29.64177309161459, -58.40677307789623, 0.8755486111122096]], [[-31.63028920106364, -26.34902992030142, 23.847106651245564]], [[23.82769422481403, -47.530469675767065, 26.330768742930562]], [[19.339371553248522, -39.38140519733587, 0.750388108556511]], [[14.258002193894328, -36.22359669975339, 14.447507014061616]], [], []]
# tips_list = [[], [], [], [[-12.06024188981844, -6.634343781909498, 10.007424117295178]], [], [], [], [], [[8.457312120607343, 12.692589203433705, -2.678435775833682], [-16.390338695817555, -3.017191274423392, -3.4069728213051746]], [[-18.094145813017228, -15.196146900905628, 24.778298429803595]], [[-22.513132531907218, -5.090463019904279, -3.2266340058054173]], [[10.88659237867798, 22.113688751112786, -4.417657483213717], [-18.780246067002878, -4.02605152024076, 25.48645331564459]], [[7.89864591014368, 19.660661742586896, -1.5468712816007026]], [[-22.78063638026449, -25.29703493265983, 26.18111520233967], [6.657148213294272, 34.46743453365785, -2.371677067525159]], [[7.119570960999411, 12.004135683000055, 23.10366119626884], [3.089688955122639, 9.940626314806211, -1.3339889695946625]], [[-1.8523117174827286, 0.939380622590206, -1.2818232337395077]], [[-1.7772257165573926, -47.35462408274352, 28.89589238697184]], [[-16.16366353452931, -1.9295546383169095, -4.25669329932916], [9.734794658256076, -6.457924498020283, 28.384992929325932]], [[6.720460548581756, 9.39186732882146, -3.575889884034863], [-17.230940048350266, 7.621221293012781, -2.7534263592811783], [-16.532447102578143, -6.681072787228106, 27.73002524417847]], [[-13.786084781876248, 26.1239312284019, 25.7804365533638], [-28.515585481714766, -51.745907952956145, 12.365859124708741]], [[-18.29687715020448, 23.792976550273547, 25.98442878608673]], [[-26.557920471331613, 27.93401838186387, 25.866637172260532]], [[11.493882001520289, 10.813644592342415, 0.6709965148200856], [-32.03286406016833, 36.01159046410065, 11.489314614144106]], [[9.344325721243608, 4.097863168462608, 27.488520012342327], [0.1203396022942993, 20.362274858072183, 2.040567571165574]], [[-6.390668552361115, 13.415918883608665, -1.8138024862106505]], [[-26.23358912032215, 9.81055376932629, 27.377105121213944]], [[5.849753885325812, 0.1404891230387082, 28.409982794130308]], [[7.097655301199435, 8.855635120141427, -4.3315522182156165]], [[-76.92611992020863, 16.029462236430163, 9.76966312828815]], [], []]
#
# # Spine36
# heads_list = [[[7.051663602849194, -10.213609032675318, 26.238316573962397]], [[59.969107641972805, -8.85479518538343, 11.164621226749329]], [[57.200950553537965, -13.888164955390613, 8.68723346097834]], [[9.267276195183772, -23.16605915905992, -4.403022952786493]], [], [], [], [], [], [], [], [[53.3921504736261, -17.529583208677245, -3.921772613135494]], [[47.66817117286885, 29.409508727390836, -2.7544075020581213]], [[48.10858843926057, 17.583652100244972, 10.582267455777362]], [], [], [], [], [], [], [[53.11693025194482, -14.67119860613549, -2.7402615476061305]], [[44.55999006997716, 46.247077714602035, -1.3255980768660693]], [[39.61519156071269, 45.766395007664265, -1.140910269911968]], [[28.917266408226986, 49.56197991555261, -0.7539047418571772]], [[24.578057548582464, 47.9698020153283, -0.08083531939823196]], [[57.144482793398815, 34.07300779414255, 29.01888903853451]], [[11.904946301969314, 42.075241061335625, -0.23381903447958616], [102.93742472900186, -31.46129951769226, 14.299327776519236]], [[54.60372162754132, 35.188469993428484, 14.770960126139762]], [[50.847303568272146, 33.36281105386058, 0.7329150004870351], [111.87191934078304, -17.371951172553963, 30.570749009706574]], [[53.34628569851968, -10.743589442205497, 28.682572865282367], [57.70924837985444, -18.97725162992657, -2.115600650233789]], [[66.06577021186459, 30.013208189286694, 15.97372355638963], [55.799980892178105, -12.673139507515948, 27.215100727960902]]]
# tips_list = [[[-21.094474413175938, -0.15069307732611592, 29.774265751869805]], [[-6.066570839194543, -17.60229845427617, 8.119723550589134]], [[-5.172400129797169, -18.17098702869703, 11.927175233034898]], [[-27.34377392100201, -12.222042364184642, -5.268599570814283]], [], [], [], [], [], [], [], [[8.370641186473016, -1.403129428282345, -3.809176003629659]], [[3.9142787631497713, 25.952594298664867, -2.359704513304098]], [[5.1552001639598455, 11.545094261634885, 12.538283088698657]], [], [], [], [], [], [], [[8.51692678820676, -7.329934018929623, -3.348240356493972]], [[6.097245599331696, 5.846656864552564, -0.8026754011444907]], [[5.023061335007645, 6.547237060036576, -1.09994799454298]], [[6.924959946560213, -2.1880230651024988, -4.776212742374518]], [[4.6487552686859575, 5.706428195352035, -0.8585773868628727]], [[-6.020637977180335, 27.63448279721665, 27.261427846215348]], [[-4.057821024947215, 18.942030982605296, -1.4868571244517697], [10.51671770423447, -6.347014762953792, 16.59347242075828]], [[-10.26567350347354, 22.63668902493908, 13.073876637136115]], [[-14.112490547906555, 22.957133002209886, 0.08336188844633008], [8.316108485340393, -3.0704161876459097, 29.519646594186586]], [[18.206613433465265, -10.463125941060923, 28.404195690423162], [8.186707885936762, -6.995000555431522, -3.5979815612081083]], [[-18.499607801448644, 25.641584359029494, 11.122290162929437], [14.760478484571045, -10.523329801866112, 30.83392326045619]]]
#


# Synbone04
heads_list = [[[32.33313175744235, -23.06040684640031, 15.038579963856614], [27.93193486184896, -19.337059832783563, -19.887874524099345]], [[33.65574449229256, -21.896449091322474, 15.015845336815051], [30.393901232562172, -17.03928325668788, -19.13500340316788]], [[-35.2248350705461, -20.44281045451746, -21.485321599197363], [34.576090146712446, -20.73390047405995, 15.204676449455182]], [[37.03213913518033, -19.320462068043756, 15.099632448947787], [-36.30479263938596, -22.273330384715308, -22.24461624018771]], [], [], [], [[35.214062226035, -19.868289666910364, 15.36696957267635], [29.589601262723953, -16.749000990440287, -19.50984481410113], [-32.482842532325606, -19.394235775733932, -24.18552738521841]], [[30.600706011652896, -16.200961913526314, -18.319235356458734], [36.57185753123723, -20.380991947809342, 15.752976279375456], [-32.15176284557917, -19.079531534734294, -21.346276641854313]], [[28.75705938312202, -18.647626369208243, -19.459247452717605], [33.600727512402536, -21.946031756131582, 15.037280503113884], [-34.05515406451957, -20.889505032455403, -21.101848565966478]], [[-34.573133786714905, -20.345898774645434, -21.840838346524322], [29.912404471533677, -17.54523032965158, -18.656533973376895], [34.35395536478315, -21.15368045444458, 15.161087703495111]], [[-33.048301505001895, -18.1830799051966, -21.34412996677416], [29.48945232397084, -16.448982632141053, -18.998538261722658], [35.01887904573019, -20.190631658015086, 15.29647111096612]], [[29.55193077746825, -14.938596799049808, -18.690803505174042], [-31.725140566737032, -16.694096240207358, -21.609003509453046], [34.37746121811928, -23.201360922888043, 15.269234734375342]], [[28.95701467314455, -16.245074869016097, -19.532305403617677], [-31.454494652342966, -17.91020712287591, -23.65928509267718], [34.90087186780609, -21.398956607789117, 15.030376576678552]], [[-33.30819176565666, -18.862351552687723, -21.643616888049714], [29.138602608413287, -17.188512228098354, -19.76936259913633], [34.76319372588287, -19.479451904472697, 15.018033162073415]], [[-32.06642112627211, -18.471436459434358, -21.990397515776685], [34.27464007645368, -20.59892235064146, 15.37608920230646], [30.18627834529652, -16.96519179916636, -19.12614796768839]], [[29.179847252920005, -18.16363570340281, -19.327701302150842], [-32.4743236367108, -19.11300283876139, -22.34595088346181], [34.92182015292397, -20.939210271766854, 15.271443242752444]], [[-33.61316534996119, -23.87853334573722, -22.309607394975686], [35.98298311938761, -23.687844222069817, 16.0977868647666], [30.335962592308476, -17.30053720756159, -18.667979210660885]], [[28.92875402711169, -16.878803258727803, -19.61126600327501], [33.94629771657131, -18.58652592375858, 14.735607645642336], [-33.48254887763866, -17.82245728015568, -21.766816206389997]], [[34.39188644500456, -19.457693649773134, 14.491263357361621], [-34.16949652801996, -16.86612237083551, -23.050379472965496], [29.928000717267498, -14.887860150524675, -19.29139949698674]], [[34.93507067897495, -18.876782260482365, 14.364016833531071], [-30.499579127899842, 46.0791512457276, -19.120747196422634]], [[33.729056921410134, -18.776262857694235, 14.189092516059597], [29.25854257158368, -13.05975576005126, -20.48839805336455]], [[44.22103758142238, -84.51508262465106, -26.523667378186857], [34.842857222187845, -21.134886295091057, 13.553947114294473], [-38.04492661076564, 32.55581643584321, -21.537751521647703]], [[35.18387585372537, -20.780968970728168, 13.744020820940271], [47.01692249498021, -74.93513864368029, -26.08896494439578], [-63.394390519447484, 108.74814541487271, -40.9502765219208]], [[33.86165215392312, -19.57854397749581, 14.204830977152147], [29.83118808189969, -16.12084910491434, -21.5111432201956], [-43.647887496216036, 20.003054274575035, -20.631280096547513]], [[34.62631320307949, -20.3489577570164, 14.255211037537775], [-32.95080380754126, -19.84218629161736, -24.04101993306192]], [[34.271310412283626, -20.9148835135559, 14.369091980722047], [21.788791171628635, -3.382298338918355, -21.61063389305285], [-49.44988997405814, 8.426103116052925, -21.236827134074]], [[33.39964469368334, -17.85855840317644, 13.600792950385562], [27.98006116945035, -15.582948672359493, -21.249034548511965], [34.766207210353414, 71.76482762235244, -77.50710679916307], [-46.079944302224135, 3.0007534079146803, -21.52115522353553]], [[32.0092079923038, -16.736115158875535, 13.000699530354245], [29.82122128014848, -14.775674817190605, -22.074045005509515], [-42.67630287715697, -5.182624951425743, -22.474556002676408]], [[33.38026888935498, -17.365304417377274, 12.864461310195537], [29.284530386547196, -12.513151823813, -22.3816766412196]], [[32.996499043591335, -18.185671689314233, 12.63767243253518], [29.712611911056925, -13.443119210544257, -23.029603828592855]]]
tips_list = [[[2.218956973524179, 12.244073102423766, 33.46487168110527], [-10.656750644249769, 26.751227423593257, -1.3003000052478328]], [[2.6773966604773247, 13.560413745604013, 33.44888608676346], [-7.644523226428186, 25.81360175966594, -3.185024371922363]], [[-6.55001157851425, 28.846248962398313, 0.23264573193991012], [1.6150277248655363, 13.84485722755783, 33.176425388385354]], [[1.9318258838782854, 15.228082632670237, 32.90671430257867], [-4.584252357947937, 31.237837566101888, 0.732572425654735]], [], [], [], [[3.268153130378491, 14.168863642927459, 33.46928609949531], [7.146046922502483, 34.757882098499394, -3.0851483543050287], [-3.4860437878222346, 28.99808116507424, 2.5064530804537846]], [[6.0595437430349355, 34.41629423780127, -4.077412288620772], [2.583434518374984, 13.52864101031358, 34.163489304637636], [-2.2005605164425734, 30.617591402757856, 2.4426538023242186]], [[5.537950806224667, 37.95824067413724, -2.5788061362106625], [2.50219545954557, 12.445949611278685, 34.12745244689739], [-2.369448349298036, 30.99737550209301, 2.141693816918097]], [[-2.4135439410567607, 32.77091648467666, 2.347803500208607], [2.8586055988609047, 34.602808637566554, -3.3808792794337283], [2.6117036698256184, 13.499942465265303, 33.97026609769905]], [[-2.642177547488904, 32.74010611649442, 1.9169875005268004], [2.303620354708433, 28.17098479618586, -5.4321103700485835], [2.469616174009805, 14.73011870996567, 33.77442558664003]], [[2.8680057364984775, 24.354873854984177, -5.573318661144234], [-3.176017931456926, 32.90345643218987, 1.754755302200636], [2.542014246575645, 15.98212690834275, 33.55448109907733]], [[1.737091752433666, 23.257838872645753, -4.483462971338283], [-3.432535437994723, 34.53014350748974, 2.1358763191934846], [2.0439560067879254, 15.193158542749988, 33.47417465533106]], [[-1.9415935865192395, 33.25308123666423, 1.2202348614973897], [2.2216024659727633, 22.40106018864944, -4.327803201475202], [2.2891369994387762, 13.10885084308151, 33.60894625360962]], [[-2.6000752444620434, 30.36152243623134, 1.686890117163564], [2.486359784377581, 13.051403732855437, 33.651183556359165], [3.0007600488236688, 21.623213068859066, -4.2430507409435645]], [[2.554545298536258, 21.62426626504496, -3.851704850292269], [-2.4081058724082025, 31.954413636023595, 2.114499413791327], [2.6857790921815488, 12.469793755356614, 33.77490558566578]], [[-1.7256313086164505, 32.447429020509276, 1.5821897726940248], [2.5355727191545405, 13.253352169208643, 33.87838489938684], [2.86012112380358, 21.78129230279393, -3.4027616599490313]], [[3.4453016175691773, 24.88764422541716, -4.041714171385652], [2.701065797485466, 13.593165977288074, 33.36594104562492], [-2.158702314481096, 32.29528808785767, 0.29459610851140416]], [[2.6953871091714263, 14.472085251132047, 33.53085265676597], [-2.505377458596974, 31.79044286637987, 0.8539097093271597], [2.1161687023439004, 24.451546328301518, -3.9675347153782368]], [[2.4920131855232954, 14.121548645195187, 33.430467918056365], [-2.6145524043276027, 29.415208363046, 1.6328121376362859]], [[2.658915115741592, 15.08185062336492, 32.90341375080924], [2.871411401051206, 24.243881511918055, -3.7860492505573085]], [[0.8837854581841955, 27.61854731784761, -3.1813645290001697], [2.5292911782062584, 12.784929340473685, 32.847084336316115], [-2.734560317788687, 30.844022446304727, 1.2814544074007939]], [[2.0217589995422918, 14.152816902111596, 32.57497944343661], [0.4120407446782144, 28.69100338816298, -2.6322465441790954], [-26.809777007915685, 98.48920607170291, -35.42430646565927]], [[2.4273956423153624, 13.253697991148744, 32.83851103843295], [1.0620436881498314, 26.63112654468414, -2.345925754260363], [-2.234109159489757, 29.39518169305172, 0.7310224804035242]], [[2.06876761623593, 13.78660811416545, 33.025527807485034], [0.36374317679335455, 28.30303449604716, -1.9008991153782653]], [[1.7714264886728304, 14.512258066910476, 32.90841977907537], [49.6026994696346, -56.662457878402805, -13.224860886795419], [-0.09396115476100597, 29.740170228544972, 0.3192349794177775]], [[1.2838721851668013, 15.540526168017433, 32.10963521212739], [-0.6437971636877187, 30.435277241148192, -2.538374086843914], [35.065428293853, 74.12695739955194, -78.94626126099428], [-1.5105557739101299, 31.391642650231304, -0.5626130198556597]], [[1.1630039202181637, 16.24826952380358, 32.32926270644199], [-5.522778041625627, 33.14065763032782, -1.6155529568871674], [-3.5732102973593305, 32.978869839139584, -0.16640943031709649]], [[0.7670661160994412, 15.807147031480723, 32.23342642595955], [-5.466807392974494, 32.13356712002445, 0.12781697088182864]], [[2.52570353892789, 15.158903673511968, 31.92033561399235], [-6.578508883344181, 31.790078601683856, -1.5438176247546027]]]

same_color = False

# Add predictions
for id, (heads, tips) in enumerate(zip(heads_list, tips_list)):
    shapes_layer = viewer.add_shapes(
        ndim=3,
        name=f"Predictions from View {id * 10}° and {90 + id * 10}°",
        edge_width=2,
        edge_color_cycle=colors,
        face_color='transparent'
    )
    for i, (head, tip) in enumerate(zip(heads, tips)):

        line_data = np.array(
            [[head[2] + 160, head[1] + 160, head[0]],
            [tip[2] + 160, tip[1] + 160, tip[0]]]
        )
        shapes_layer.add(line_data, shape_type='line', edge_color='red' if same_color else colors[i % len(colors)])

napari.run()